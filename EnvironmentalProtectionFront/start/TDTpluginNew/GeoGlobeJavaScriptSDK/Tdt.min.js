Geo.Tdt.Busline=Geo.Class({data:null,segments:null,lineName:null,initialize:function(a){if(a)for(var b in this.data=a,a)this._resultPaser[b]&&Geo.Function.bind(this._resultPaser[b],this)(a[b])},_resultPaser:{segments:function(a){for(var b=[],d=0;d<a.length;d++)b.push(new Geo.Tdt.BuslineSegment(a[d]));this.segments=b},lineName:function(a){this.lineName=a}},getFeatures:function(){for(var a=[],b=0;b<this.segments.length;b++)a=a.concat(this.segments[b].getFeatures());return a},draw:function(){for(var a=
[],b=0;b<data.length;b++)a.push(segments);this.features=segments}});
Geo.Tdt.BuslineQuery=Geo.Class({_serviceUrl:"http://www.tianditu.com/query.shtml",_requestType:"query",_httpRequest:"post",bounds:new Geo.Bounds(-180,-90,180,90),level:3,zoomOffset:0,map:null,_request:null,initialize:function(){},queryChang:function(a,b,d){this.queryChangByLonlat(a,b,d)},queryChangByLonlat:function(a,b,d){if(a&&a.start&&a.end){for(var a={startposition:a.start.lon+","+a.start.lat+"|",endposition:a.end.lon+","+a.end.lat+"|",linetype:a.linetype||1},c=["startposition","endposition","linetype"],
e="postStr=",f=[],g=0;g<c.length;g++){var h=c[g];h in a&&f.push("'"+h+"':'"+a[h]+"'")}e+="{"+f.join(",")+"}";e+="&type=busline";new Geo.Request.POST({url:this._serviceUrl,success:function(a){a=(new Geo.Format.JSON).read(a.responseText);b(new Geo.Tdt.BuslineQueryResult(a))},failure:d,data:e,headers:{"Content-Type":"application/x-www-form-urlencoded"}})}},queryStationsByKeyword:function(a,b,d){if(a){var c,e,f;c=a.count||20;e="{'keyword':'"+a.startKeyword+"','start':0,'count':"+c+"}";f="{'keyword':'"+
a.endKeyword+"','start':0,'count':"+c+"}";this.map?(a=this.map.getZoom()+this.zoomOffset,c=this.map.getExtent().toBBOX()):(a=this.level,c=this.bounds.toBBOX());e={level:"'"+a+"'",bound:"'"+c+"'",start:e,dest:f};a="postStr=";c=[];for(var g in e)c.push("'"+g+"':"+e[g]);a+="{"+c.join(",")+"}";a+="&type=routequery";new Geo.Request.POST({url:this._serviceUrl,success:function(a){a=(new Geo.Format.JSON).read(a.responseText);b(a)},failure:d,data:a,headers:{"Content-Type":"application/x-www-form-urlencoded"}})}},
setMap:function(a){if(a)this.map=a},CLASS_NAME:"Geo.Tdt.BuslineQuery"});
Geo.Tdt.BuslineQueryResult=Geo.Class({data:null,hasSubway:null,resultCode:null,error:null,results:null,initialize:function(a){if(a)for(var b in this.data=a,a)this._resultPaser[b]&&Geo.Function.bind(this._resultPaser[b],this)(a[b])},getLines:function(){return this.results[0].lines},getFeatures:function(){for(var a=[],b=0;b<this.results[0].lines.length;b++)a=a.concat(this.results[0].lines[b].getFeatures());return a},_resultPaser:{hasSubway:function(a){this.hasSubway=a},results:function(a){for(var b=
[],d=0;d<a.length;d++){for(var c=[],e=0;e<a[d].lines.length;e++)c.push(new Geo.Tdt.Busline(a[d].lines[e]));b.push({lines:c,lineType:a[d].lineType})}this.results=b},resultCode:function(a){this.resultCode=a}}});
Geo.Tdt.BuslineSegment=Geo.Class({data:null,segmentLine:null,segmentFeature:null,stationEnd:null,endFeature:null,stationStart:null,startFeature:null,segmentType:null,initialize:function(a){if(a)for(var b in this.data=a,a)this._resultPaser[b]&&Geo.Function.bind(this._resultPaser[b],this)(a[b])},getFeatures:function(){var a=[];a.push(this.endFeature);a.push(this.startFeature);return a=a.concat(this.segmentFeature)},_resultPaser:{segmentLine:function(a){for(var b=[],d=0;d<a.length;d++){var c=Geo.Tdt.Util.lineStringToGeometry(a[d].linePoint),
c=new Geo.Feature.Vector(c,a[d]);b.push(c)}this.segmentLine=a;this.segmentFeature=b},segmentType:function(a){this.segmentType=a},stationStart:function(a){var b=Geo.LonLat.fromString(a.lonlat),b=new Geo.Geometry.Point(b.lon,b.lat);this.startFeature=new Geo.Feature.Vector(b,a);this.stationStart=a},stationEnd:function(a){var b=Geo.LonLat.fromString(a.lonlat),b=new Geo.Geometry.Point(b.lon,b.lat);this.endFeature=new Geo.Feature.Vector(b,a);this.stationEnd=a}}});
Geo.Tdt.ChangeCity=Geo.Class({_serviceUrl:"http://www.tianditu.com/query.shtml",_requestType:"query",_httpRequest:"post",bounds:new Geo.Bounds(-180,-90,180,90),level:3,zoomOffset:0,map:null,initialize:function(a){Geo.Util.extend(this,a)},getCityInfo:function(a,b,d){var c=a.lonlat,e=a.bound,a=a.zoom,f=this.map;f&&(c=c||f.getCenter(),e=f.getExtent(),a=a||f.getZoom()+this.zoomOffset);var c={lonlat:c.lon+","+c.lat,level:this._getLevelFromMapZoom(a),bound:e.toBBOX(),zoom:a},e="postStr=",a=[],g;for(g in c)a.push("'"+
g+"':'"+c[g]+"'");e+="{"+a.join(",")+"}";e+="&type=changeCity";new Geo.Request.POST({url:this._serviceUrl,success:function(a){a=(new Geo.Format.JSON).read(a.responseText);b(a)},failure:d,data:e,headers:{"Content-Type":"application/x-www-form-urlencoded"}})},_getLevelFromMapZoom:function(a){var a=a||0,b;a<2?b=-1:a<6?b=2:a<11?b=3:a<18?b=4:a<20&&(b=5);return b}});
Geo.Tdt.DriveQuery=new Geo.Class({_serviceUrl:"http://www.tianditu.com/query.shtml",_requestType:"query",_httpRequest:"post",_request:null,initialize:function(){},query:function(a,b,d){if(a){var c=a.start,e=a.end,f=a.lineType,g;g=[];if(a.mid){for(var a=Geo.Util.isArray(a.mid)?mid:[mid],h=0;h<a.length;h++)g.push(a[h].lon+","+a[h].lat);g=g.join(";")}else g="";var c={orig:c.lon+","+c.lat,dest:e.lon+","+e.lat,style:f||Geo.Tdt.DriveQuery.LINE_TYPE_QUICK,mid:g},e="postStr=",f=[],i;for(i in c)f.push("'"+
i+"':'"+c[i]+"'");e+="{"+f.join(",")+"}";e+="&type=search";b=b||this.onSuccess;d=d||this.onFailure;new Geo.Request.POST({url:this._serviceUrl,success:function(a){var c=new Geo.Tdt.DriveQueryResultFormat,a=new Geo.Tdt.DriveQueryResult(c.read(a.responseText));b(a)},failure:d,data:e,headers:{"Content-Type":"application/x-www-form-urlencoded"}})}}});Geo.Tdt.DriveQuery.LINE_TYPE_QUICK=0;Geo.Tdt.DriveQuery.LINE_TYPE_SHORT=1;Geo.Tdt.DriveQuery.LINE_TYPE_NOHIGHWAY=2;Geo.Tdt.DriveQuery.LINE_TYPE_WALK=3;
Geo.Tdt.DriveQueryResult=new Geo.Class({data:null,orig:null,dest:null,startFeature:null,endFeature:null,midFeatures:null,routes:null,segmentFeatures:null,distance:null,duration:null,routelatlon:null,initialize:function(a){if(a)for(var b in this.data=a,a)this._resultPaser[b]&&Geo.Function.bind(this._resultPaser[b],this)(a[b])},_resultPaser:{parameters:function(a){this.start=Geo.LonLat.fromString(a.orig);this.end=Geo.LonLat.fromString(a.dest);for(var a=a.mid.split(";"),b=[],d=0;d<a.length;d++){var c=
Geo.LonLat.fromString(a[d]),c=new Geo.Geometry.Point(c.lon,c.lat);b.push(new Geo.Feature.Vector(c))}this.midFeatures=b;a=new Geo.Geometry.Point(this.start.lon,this.start.lat);this.startFeature=new Geo.Feature.Vector(a);a=new Geo.Geometry.Point(this.end.lon,this.end.lat);this.endFeature=new Geo.Feature.Vector(a)},routes:function(a){this.routes=a},simple:function(a){for(var a=a.items,b=[],d=0;d<a.length;d++){var c=Geo.Tdt.Util.lineStringToGeometry(a[d].streetLatLon);b.push(new Geo.Feature.Vector(c,
a[d]))}this.segmentFeatures=b},distance:function(a){this.distance=a},duration:function(a){this.duration=a},routelatlon:function(a){this.routelatlon=a},mapinfo:function(a){this.mapinfo=a}}});
Geo.Tdt.DriveQueryResultFormat=new Geo.Class(Geo.Format.XML,{initialize:function(a){OpenLayers.Format.XML.prototype.initialize.apply(this,[a])},read:function(a){var b=null;typeof a=="string"&&(a=Geo.Format.XML.prototype.read.apply(this,[a]));if(a&&a.nodeType==9)for(var b={},a=a.getElementsByTagName("result")[0].childNodes,d=0;d<a.length;d++){var c=a[d],e=c.nodeName;if(this._resultPaser[e])this._resultPaser[e](c,b)}return b},_resultPaser:{parameters:function(a,b){var d=a.childNodes;b.parameters={};
for(var c=0;c<d.length;c++)a=d[c],b.parameters[a.nodeName]=a.text},routes:function(a,b){function d(a,b){for(var c=a.childNodes,d=0;d<c.length;d++)b[c[d].nodeName]=c[d].text}var c=a.attributes,e=a.childNodes;b.routes={};for(var f=0;f<c.length;f++){var g=c[f];b.routes[g.nodeName]=g.text}for(f=0;f<e.length;f++){if(!b.routes.items)b.routes.items=[];a=e[f];c={};d(a,c);b.routes.items.push(c)}},simple:function(a,b){function d(a,b){for(var c=a.childNodes,d=0;d<c.length;d++)b[c[d].nodeName]=c[d].text}b.simple=
{};for(var c=a.childNodes,e=0;e<c.length;e++){if(!b.simple.items)b.simple.items=[];var a=c[e],f={};d(a,f);b.simple.items.push(f)}},distance:function(a,b){b.distance=new Number(a.text)},duration:function(a,b){b.duration=new Number(a.text)},routelatlon:function(a,b){b.routelatlon=a.text},mapinfo:function(a,b){b.mapinfo={};for(var d=a.childNodes,c=0;c<d.length;c++)b.mapinfo[d[c].nodeName]=d[c].text}}});
Geo.Tdt.PlaceQuery=Geo.Class({_serviceUrl:"http://www.tianditu.com/query.shtml",_requestType:"query",_httpRequest:"post",_request:null,queryParams:null,queryResult:null,bounds:new Geo.Bounds(-180,-90,180,90),level:3,zoomOffset:0,map:null,perPage:20,queryTerminal:1E4,initialize:function(a){Geo.Util.extend(this,a)},onStatistics:function(){},onPois:function(){},onFailure:function(){},toPage:function(a){this.queryResult&&this.queryResult.CLASS_NAME=="Geo.Tdt.PlaceQueryResultPios"&&(a=parseInt(a),isNaN(a)||
(a=a<=0?1:a,a=a>this.queryResult.totalPage?this.queryResult.totalPage:a,a!=this.queryResult.pageNo&&this.query(this.queryResult.queryParams,null,null,this.queryResult.perPage,(a-1)*this.queryResult.perPage,a)))},firstPage:function(){this.toPage(1)},lastPage:function(){this.toPage(this.getTotalPage())},nextPage:function(){this.toPage(this.getPageNo()+1)},prePage:function(){this.toPage(this.getPageNo()-1)},getPageNo:function(){var a=this.queryResult;if(a&&a.pageNo)return this.queryResult.pageNo;return 0},
getTotalPage:function(){var a=this.queryResult;if(a&&a.totalPage)return this.queryResult.totalPage;return 0},getTotalCount:function(){var a=this.queryResult;if(a&&a.totalCount)return this.queryResult.totalCount;return 0},query:function(a,b,d,c,e,f){if(a){f=f||1;Geo.Util.extend({},a);var g=Geo.Util.extend({},a);if(this.map){var h=this.map.getZoom()+this.zoomOffset;g.level=g.level||h;h=this.map.getExtent().toBBOX();g.mapBound=g.mapBound||h}g.queryType=g.queryType||1;g.count=c||this.perPage;g.start=
e||0;for(var c=["keyWord","level","mapBound","pointLonlat","queryRadius","queryType","specifyAdminCode","count","start"],e="postStr=",h=[],i=0;i<c.length;i++){var j=c[i];j in g&&h.push("'"+j+"':'"+g[j]+"'")}e+="{"+h.join(",")+"}";e+="&type=query";d=d||this.onFailure;this._request=new Geo.Request.POST({url:this._serviceUrl,scope:this,success:function(c){c=(new Geo.Format.JSON).read(c.responseText);c=this._parseResult(c,a,f);if(b)b(c);else{if(c.CLASS_NAME=="Geo.Tdt.PlaceQueryResultStatistics")this.onStatistics(c);
if(c.CLASS_NAME=="Geo.Tdt.PlaceQueryResultPios")this.onPois(c);this.queryResult=c}},failure:d,data:e,headers:{"Content-Type":"application/x-www-form-urlencoded"}})}},_parseResult:function(a,b,d){var c;a&&a.resultType==1&&(c=new Geo.Tdt.PlaceQueryResultPios({data:a,queryObj:this,queryParams:b,pageNo:d}));if(a&&a.resultType==2)c=new Geo.Tdt.PlaceQueryResultStatistics(a),c.requestParams=b;return c},queryByKeyword:function(a,b,d){this.query({keyWord:a},b,d)},queryByAdminCode:function(a,b,d,c){this.query({keyWord:a,
specifyAdminCode:b},d,c)},queryByBounds:function(a,b,d,c,e){b=b?b.toBBOX():null;this.query({keyWord:a,mapBound:b,level:d===null||d===void 0?d:null,queryType:2},c,e)},queryByNear:function(a,b,d,c,e){queryObj.query({keyWord:a,pointLonlat:b.lon+","+b.lat,queryRadius:d||500,queryType:3},c,e)},queryBusSuggest:function(a,b,d,c){queryObj.query({keyWord:a,count:b||10,start:0,queryType:5},d,c)},queryPlaceNameSuggest:function(a,b,d,c){queryObj.query({keyWord:a,count:b||10,start:0,queryType:4},d,c)},setMap:function(a){if(a)this.map=
a},CLASS_NAME:"Geo.Tdt.PlaceQuery"});
Geo.Tdt.PlaceQueryResultPios=Geo.Class({queryObj:null,queryParams:null,data:null,start:null,count:null,keyWord:null,features:null,totalCount:null,perPage:20,pageNo:1,totalPage:null,initialize:function(a){Geo.Util.extend(this,a);if(a=this.data)for(var b in a)this._resultPaser[b]&&Geo.Function.bind(this._resultPaser[b],this)(a[b])},_makeFeatures:function(a){if(a){this.features=[];for(var b=0;b<a.length;b++){var d=a[b],c=d.lonlat.split(" "),c=new Geo.Geometry.Point(c[0],c[1]);this.features.push(new Geo.Feature.Vector(c,
d))}}},_resultPaser:{count:function(a){this.totalCount=new Number(a);this.totalPage=Math.ceil(this.totalCount/this.perPage)},pois:function(a){this._makeFeatures(a)},resultType:function(){},landmarkcount:function(){},prompt:function(){},keyWord:function(a){this.keyWord=a},version:function(){}},CLASS_NAME:"Geo.Tdt.PlaceQueryResultPios"});
Geo.Tdt.PlaceQueryResultStatistics=Geo.Class({queryObj:null,queryParams:null,data:null,keyWord:null,count:null,citysCount:null,countryCount:null,provinceCount:null,allAdmins:null,initialize:function(a){if(a)for(var b in this.data=a,a)this._resultPaser[b]&&Geo.Function.bind(this._resultPaser[b],this)(a[b])},_resultPaser:{count:function(a){this.count=new Number(a)},keyWord:function(a){this.keyWord=a},statistics:function(a){if(a)for(var b in a){if(b=="allAdmins")this.allAdmins=a[b];if(b=="citysCount")this.citysCount=
new Number(a[b]);if(b=="countryCount")this.countryCount=new Number(a[b]);if(b=="provinceCount")this.provinceCount=new Number(a[b])}}},CLASS_NAME:"Geo.Tdt.PlaceQueryResultStatistics"});Geo.Tdt.Util={lineStringToGeometry:function(a){for(var b=[],a=a.split(";"),d=0;d<a.length;d++){var c=a[d].split(",");c.length==2&&(c=new Geo.Geometry.Point(c[0],c[1]),b.push(c))}return new Geo.Geometry.LineString(b)}};
Geo.Tdt.Weather=Geo.Class({_serviceUrl:"http://www.tianditu.com/query.shtml",_requestType:"weather",_httpRequest:"post",_request:null,initialize:function(a){Geo.Util.extend(this,a)},query:function(a,b,d){if(a){var a={weatherCode:a.weatherCode,days:a.days},c="postStr=",e=[],f;for(f in a)e.push("'"+f+"':'"+a[f]+"'");c+="{"+e.join(",")+"}";c+="&type=weather";d=d||this.onFailure;this._request=new Geo.Request.POST({url:this._serviceUrl,scope:this,success:function(a){a=(new Geo.Format.JSON).read(a.responseText);
b&&b(a)},failure:d,data:c,headers:{"Content-Type":"application/x-www-form-urlencoded"}})}},CLASS_NAME:"Geo.Tdt.Weather"});
